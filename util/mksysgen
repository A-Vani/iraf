#!/bin/sh
#

# Initialize the $iraf and environment.
if [ -z "$iraf" ]; then
  if [ -e "$HOME/.iraf/setup.sh" ]; then
    . "$HOME/.iraf/setup.sh"
  else
    . unix/hlib/setup.sh
  fi
else
    . "$iraf/unix/hlib/setup.sh"
fi


if [ -z "$iraf" ]; then
    iraf=$(pwd)/
fi

if [ -e "$HOME/.iraf/arch" ]; then
  if [ -n "$IRAFARCH" ]; then
    iarch=$(cat "$HOME/.iraf/arch")
    if [ "$iarch" != "$IRAFARCH" ]; then
      echo
      echo 'Error:  Your $IRAFARCH does not match $HOME/.iraf/arch,'
      echo '        Please change $IRAFARCH or rerun install script.'
      echo
      exit 1
    fi
  fi
fi

c_start=$(date)
rm -f spool */spool


"$iraf/util/mkclean"				# clean old binaries

cd "$iraf/unix"					# NOVOS bootstrap
. hlib/irafuser.sh
sh -x mkpkg.sh 2>&1 | tee -a spool

cd "$iraf/sys"					# build NOVOS
mkpkg 2>&1 | tee -a spool

cd "$iraf/unix/boot"				# VOS bootstrap
. ../hlib/irafuser.sh
sh -x mkpkg.sh 2>&1 | tee -a spool
mv -v "$hlib"/*.e "$hbin"

cd "$iraf/vendor"                               # build vendor libs
make all 2>&1 | tee -a ../spool.final
cd ../

cd "$iraf/"					# build core system
mkpkg 2>&1 | tee -a spool

cd "$iraf/noao"					# build NOAO package
export noao=$(pwd)/
mkpkg -p noao 2>&1 | tee -a ../spool.final

rm -rf bin*/pkgconfig			# misc clean up

c_end=$(date)


echo
echo
echo
echo "Start:  $c_start"
echo "  End:  $c_end"
